<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¤ªå²å…‰æ˜ç¯æŠ¥åè¡¨å•ï¼ˆæ­£å¼ä¿®æ­£ç‰ˆï¼‰</title>
  <style>
    body { font-family: Arial, sans-serif; font-size: 18px; background: linear-gradient(to bottom, #fff5e6, #ffeaea); margin: 0; padding: 20px; }
    .container { width: 90%; max-width: 500px; margin: auto; text-align: center; }
    h2, h3 { color: #b80000; text-shadow: 1px 1px 2px #ffd700; }
    .field { margin-bottom: 10px; display: flex; flex-direction: column; align-items: flex-start; }
    label { font-size: 16px; margin-bottom: 5px; }
    input, select { font-size: 16px; padding: 8px; width: 100%; box-sizing: border-box; border: 2px solid #ccc; border-radius: 5px; }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type="number"] { appearance: textfield; }
    button { margin: 8px; padding: 10px 15px; font-size: 16px; border: none; background: linear-gradient(145deg, #d0021b, #ff5e62); color: #fff9e3; font-weight: bold; border-radius: 10px; cursor: pointer; box-shadow: 0 2px 5px rgba(255, 0, 0, 0.3); transition: background 0.3s; }
    button:hover { background: linear-gradient(145deg, #b80012, #e44c50); }
    .card { background: #fff; margin: 10px 0; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: left; }
    .card-header { display: flex; justify-content: space-between; align-items: center; }
    .total { font-size: 20px; font-weight: bold; color: #b80000; margin-top: 20px; }
    .hidden { display: none; }
  </style>
</head>
<body>
<div class="container">
  <h2>å¤ªå²å…‰æ˜ç¯æŠ¥åè¡¨å•</h2>

  <div id="mainInfo">
    <div class="field">
      <label>ä¸»ç¥ˆè€…å§“å:</label>
      <input type="text" id="mainName">
    </div>
    <div class="field">
      <label>ç”µè¯:</label>
      <input type="text" id="phoneNumber">
    </div>
    <button type="button" onclick="startForm()">å¼€å§‹å¡«å†™</button>
  </div>

  <div id="cardSection" class="hidden">
    <h3>å¡«å†™èµ„æ–™</h3>
    <div id="cardsContainer"></div>
    <button type="button" onclick="addCard()">æ–°å¢ä¸€ä½</button>
    <div class="total" id="totalAmount">èµåŠ©æ€»é‡‘é¢ï¼š0 å…ƒ</div>
    <button type="button" onclick="previewForm()">é¢„è§ˆèµ„æ–™</button>
    <button type="button" onclick="submitForm()">ç¡®è®¤é€å‡º</button>
    
  </div>

  <div id="previewSection" class="hidden">
    <h3>èµ„æ–™é¢„è§ˆ</h3>
    <div id="previewContent" style="text-align: center; font-size: 16px; padding: 10px; max-width: 380px; margin: 0 auto;"></div>
    <button type="button" onclick="backToEdit()">è¿”å›å¡«å†™</button>
    <button onclick="downloadPdf()">ä¸‹è½½PDF</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
let formData = [];
let mainName = "";
let phoneNumber = "";

function startForm() {
  mainName = document.getElementById("mainName").value.trim();
  phoneNumber = document.getElementById("phoneNumber").value.trim();
  if (!mainName || !phoneNumber) {
    alert("\u8bf7\u586b\u5199\u4e3b\u7948\u8005\u59d3\u540d\u548c\u7535\u8bddï¼");
    return;
  }
  document.getElementById("mainInfo").classList.add("hidden");
  document.getElementById("cardSection").classList.remove("hidden");
  addCard();
}

function addCard() {
  formData.push({ name: "", zodiac: "", taiSui: "", paperGold1: "", light: "", paperGold2: "", longevity: "", paperGold3: "", wisdom: "", paperGold4: "", arhat: "", paperGold5: "", donation: "" });
  renderCards();
  calculateTotal();
}

function removeCard(idx) {
  if (confirm("\u786e\u5b9a\u5220\u9664\u8fd9\u4e00\u4f4d\u5417ï¼Ÿ")) {
    formData.splice(idx, 1);
    renderCards();
    calculateTotal();
  }
}

function renderCards() {
  const container = document.getElementById("cardsContainer");
  container.innerHTML = "";
  formData.forEach((entry, idx) => {
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div class="card-header">
        <strong>ç¬¬ ${idx + 1} ä½</strong>
        <button type="button" onclick="removeCard(${idx})">åˆ é™¤</button>
      </div>
      ${generateField("å§“å", "name", idx, entry.name)}
      ${generateField("ç”Ÿè‚–", "zodiac", idx, entry.zodiac)}
      ${generateSelect("å¤ªå²", "taiSui", idx, entry.taiSui)}
      ${generateField("çº¸é‡‘", "paperGold1", idx, entry.paperGold1, true)}
      ${generateSelect("å…‰æ˜ç¯", "light", idx, entry.light)}
      ${generateField("çº¸é‡‘", "paperGold2", idx, entry.paperGold2, true)}
      ${generateSelect("é•¿ç”Ÿç¦„ä½", "longevity", idx, entry.longevity)}
      ${generateField("çº¸é‡‘", "paperGold3", idx, entry.paperGold3, true)}
      ${generateSelect("æ–‡æ˜Œå¸å›", "wisdom", idx, entry.wisdom)}
      ${generateField("çº¸é‡‘", "paperGold4", idx, entry.paperGold4, true)}
      ${generateSelect("åå…­ç½—æ±‰", "arhat", idx, entry.arhat)}
      ${generateField("çº¸é‡‘", "paperGold5", idx, entry.paperGold5, true)}
      ${generateField("å®‰å¥‰åŠŸå¾·é‡‘", "donation", idx, entry.donation, true)}
    `;
    container.appendChild(card);
  });
}

function generateField(label, key, idx, value, isNumber = false) {
  return `<div class="field"><label>${label}:</label><input type="${isNumber ? "number" : "text"}" value="${value || ""}" onchange="updateField(${idx}, '${key}', this.value)"></div>`;
}

function generateSelect(label, key, idx, value) {
  return `<div class="field"><label>${label}:</label><select onchange="updateField(${idx}, '${key}', this.value)"><option value="" ${value === "" ? "selected" : ""}></option><option value="æ˜¯" ${value === "æ˜¯" ? "selected" : ""}>æ˜¯</option></select></div>`;
}

function updateField(idx, key, value) {
  formData[idx][key] = value;
  calculateTotal();
}

function calculateTotal() {
  let total = 0;
  formData.forEach(entry => {
    const sumPaper = (parseFloat(entry.paperGold1 || 0) + parseFloat(entry.paperGold2 || 0) + parseFloat(entry.paperGold3 || 0) + parseFloat(entry.paperGold4 || 0) + parseFloat(entry.paperGold5 || 0));
    const donation = parseFloat(entry.donation || 0);
    total += (sumPaper * 3) + donation;
  });
  document.getElementById("totalAmount").textContent = `èµåŠ©æ€»é‡‘é¢ï¼š${total} å…ƒ`;
}

function previewForm() {
  document.getElementById("cardSection").classList.add("hidden");
  document.getElementById("previewSection").classList.remove("hidden");
  let html = `<p><strong>ä¸»ç¥ˆè€…ï¼š</strong>${mainName}</p><p><strong>ç”µè¯ï¼š</strong>${phoneNumber}</p><hr>`;
  formData.forEach((entry, idx) => {
    html += `
      <p><strong>ç¬¬ ${idx + 1} ä½</strong></p>
      <p>å§“å: ${entry.name || ""}ï½œç”Ÿè‚–: ${entry.zodiac || ""}</p>
      <p>å¤ªå²: ${entry.taiSui || ""}ï½œçº¸é‡‘: ${entry.paperGold1 || ""}</p>
      <p>å…‰æ˜ç¯: ${entry.light || ""}ï½œçº¸é‡‘: ${entry.paperGold2 || ""}</p>
      <p>é•¿ç”Ÿç¦„ä½: ${entry.longevity || ""}ï½œçº¸é‡‘: ${entry.paperGold3 || ""}</p>
      <p>æ–‡æ˜Œå¸å›: ${entry.wisdom || ""}ï½œçº¸é‡‘: ${entry.paperGold4 || ""}</p>
      <p>åå…­ç½—æ±‰: ${entry.arhat || ""}ï½œçº¸é‡‘: ${entry.paperGold5 || ""}</p>
      <p>å®‰å¥‰åŠŸå¾·é‡‘: ${entry.donation || ""}</p>
      <hr>
    `;
  });
  html += `<p><strong>${document.getElementById("totalAmount").textContent}</strong></p>`;
  document.getElementById("previewContent").innerHTML = html;
}


function backToEdit() {
  document.getElementById("previewSection").classList.add("hidden");
  document.getElementById("cardSection").classList.remove("hidden");
}

function submitForm() {
  calculateTotal();
  const totalAmount = document.getElementById("totalAmount").textContent.match(/\d+/)[0];

  fetch("https://wandering-moon-bdc2.jeenty.workers.dev/gas2", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      mainName: mainName,
      phoneNumber: phoneNumber,
      totalAmount: totalAmount,
      data: formData
    })
  })
  .then(response => response.text())
  .then(text => {
    try {
      const data = JSON.parse(text);
      if (data.success) {
        alert("æäº¤æˆåŠŸï¼");
        location.reload();
      } else {
        alert("æäº¤å¤±è´¥ï¼š" + (data.error || "æœªçŸ¥é”™è¯¯"));
      }
    } catch (err) {
      console.error("è¿”å›å†…å®¹ä¸æ˜¯JSONï¼š", text);
      alert("æäº¤å¤±è´¥ï¼ŒæœåŠ¡å™¨è¿”å›å¼‚å¸¸å†…å®¹ï¼");
    }
  })
  .catch(err => {
    alert("æäº¤å¤±è´¥ï¼š" + err.message);
  });
}

function downloadPdf() {
  const previewSection = document.getElementById("previewSection");
  const previewArea = document.getElementById("previewContent");
  const { jsPDF } = window.jspdf;

  previewSection.classList.remove("hidden");

  requestAnimationFrame(() => {
    html2canvas(previewArea, { scale: 2, useCORS: true }).then(canvas => {
      if (!canvas || !canvas.width || !canvas.height) {
        alert("æˆªå›¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥å†…å®¹æ˜¯å¦æ­£ç¡®ï¼");
        return;
      }

      const imgData = canvas.toDataURL('image/jpeg', 1.0);

      // ğŸ’¥ è®¾ç½®å°ç¥¨å°ºå¯¸ï¼Œæ¯”å¦‚ 80mmå®½ x è‡ªåŠ¨é«˜
      const ticketWidth = 80; // å°ç¥¨å®½åº¦ (å•ä½ mm)
      const imgAspectRatio = canvas.width / canvas.height;
      const ticketHeight = ticketWidth / imgAspectRatio;

      const pdf = new jsPDF('p', 'mm', [ticketWidth, ticketHeight]);

      pdf.addImage(imgData, 'JPEG', 0, 0, ticketWidth, ticketHeight);

      pdf.save('å¤ªå²å…‰æ˜ç¯_æŠ¥åå°ç¥¨.pdf');

      previewSection.classList.add("hidden");
      document.getElementById("cardSection").classList.remove("hidden");
    });
  });
}






</script>
</body>
</html>
