<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ“± æ‰‹æœºç«¯ç¥ˆç¦åå°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <style>
    body { background-color: #fff8e7; padding-top: 80px; font-family: "Segoe UI", sans-serif; }
    .btn-group-mobile { display: flex; flex-direction: column; gap: 10px; }
    @media (min-width: 768px) {
      .btn-group-mobile { flex-direction: row; justify-content: center; }
    }
    #loginBox {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: #fff8e7;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .card-label { font-weight: bold; color: #555; font-size: 14px; margin-top: 6px; }
  </style>
</head>
<body>
  <div id="loginBox">
    <h4 class="mb-3">è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç </h4>
    <input id="loginPass" placeholder="å¯†ç " class="form-control mb-2" type="password" style="max-width:300px;">
    <button onclick="checkLogin()" class="btn btn-primary">ç™»å½•</button>
  </div>

  <nav class="navbar fixed-top bg-light shadow-sm px-3">
    <div class="container-fluid d-flex justify-content-between align-items-center">
      <span class="navbar-brand">ğŸ™ ç¥ˆç¦åå°ï¼ˆæ‰‹æœºç«¯ï¼‰</span>
      <span class="text-end">
        ç®¡ç†å‘˜ï¼š<span id="whoLogin" class="fw-bold text-primary"></span>
        <button onclick="logout()" class="btn btn-sm btn-outline-danger ms-2">ç™»å‡º</button>
      </span>
    </div>
  </nav>

  <div class="container">
    <div class="mb-3">
      <div class="input-group">
        <input type="text" id="searchInput" class="form-control" placeholder="è¾“å…¥æ‰‹æœºå·æŸ¥è¯¢...">
        <button onclick="searchPhone()" class="btn btn-primary">æŸ¥è¯¢</button>
      </div>
    </div>

    <div id="resultSelector" class="mb-3"></div>
    <div id="adminForm" class="d-none"></div>
  </div>

  <script>
    const users = {
      "pw123": "amy",
      "pw456": "ben",
      "qifu2024": "æå¸ˆå…„"
    };

    function checkLogin() {
      const p = document.getElementById("loginPass").value.trim();
      if (users[p]) {
        const u = users[p];
        localStorage.setItem("admin", u);
        document.getElementById("whoLogin").textContent = u;
        document.getElementById("loginBox").style.display = "none";
        document.getElementById("adminForm").classList.remove("d-none");
      } else {
        alert("å¯†ç é”™è¯¯");
      }
    }

    function logout() {
      localStorage.removeItem("admin");
      location.reload();
    }

    if (localStorage.getItem("admin")) {
      document.getElementById("whoLogin").textContent = localStorage.getItem("admin");
      document.getElementById("loginBox").style.display = "none";
      document.getElementById("adminForm").classList.remove("d-none");
    }

    async function searchPhone() {
      const keyword = document.getElementById("searchInput").value.trim();
      if (!keyword) return alert("âš ï¸ è¯·è¾“å…¥æ‰‹æœºå·");

      const res = await fetch("https://form.gealarm2012.workers.dev/admin-qifu?search=" + encodeURIComponent(keyword));
      const list = await res.json();
      const data = Array.isArray(list) ? list[0] : list;
      const prayers = data.data || data.prayers || [];

      if (!Array.isArray(prayers)) return alert("âš ï¸ æŸ¥æ— æ•°æ®");

      data.prayers = prayers;
      renderForm(data);
    }

    function padDate(input) {
      if (!input) return "";
      const d = new Date(input);
      if (isNaN(d)) return "";
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    }

    function renderForm(entry) {
      const container = document.getElementById("adminForm");
      container.classList.remove("d-none");
      container.innerHTML = `
        <div class="card p-3">
          <h5>ğŸ“Œ ç¥ˆç¦èµ„æ–™</h5>
          <div class="card-label">è¡¨æ ¼å¡«å†™è€…</div><div>${entry.mainName || "-"}</div>
          <div class="card-label">æ‰‹æœºå·</div><div>${entry.phoneNumber || "-"}</div>
          <div class="card-label">æ³•ä¼šç±»åˆ«</div><div>${entry.dharmaType || "-"}</div>
          <div class="card-label">æ”¶æ®ç¼–å·</div><div>${entry.receiptNumber || "â€”"}</div>
          <div class="card-label">æ”¶æ¬¾æ—¥æœŸ</div><div>${padDate(entry.receiptDate)}</div>
          <div class="card-label">ä¾›å…»é‡‘</div><div>RM ${(+entry.sponsorAmount || 0).toFixed(2)}</div>
          <div class="card-label">æ”¶æ¬¾äºº</div><div>${entry.admin || "â€”"}</div>
        </div>
        <h6 class="mt-4">ğŸ§â€â™‚ï¸ ç¥ˆç¦è€…</h6>
        ${entry.prayers.map((p, i) => {
          const isEmpty = !p.name?.trim();
          if (isEmpty) return "";
          return `
            <div class="border p-2 rounded mb-2">
              <div><strong>${i + 1}. ${p.name}</strong></div>
              <div class="small text-muted">ğŸ  ${p.address || ""}</div>
              <div class="small">ä»¤ç‰Œ: ${p.token || 0}ï¼Œå°æŠ¤æ‘©ç‰‡: ${p.fire || 0}ï¼Œçº¸é‡‘3: ${p.pg3 || 0}ï¼Œçº¸é‡‘6: ${p.pg6 || 0}</div>
            </div>
          `;
        }).join("")}
      `;
    }
  </script>
</body>
</html>
