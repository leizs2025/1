<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>2025 å¤ªå²å…‰æ˜ç¯ æŸ¥è¯¢ç³»ç»Ÿ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: "Microsoft JhengHei", sans-serif;
      background: linear-gradient(to bottom, #fff8f0, #ffe4d4);
      padding: 20px;
      max-width: 960px;
      margin: auto;
      color: #5b2400;
      font-size: 18px;
    }
    h1 {
      text-align: center;
      color: #c9302c;
      font-size: 28px;
      margin-bottom: 30px;
    }
    .centered-input {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 20px;
    }
    input, button {
      padding: 12px;
      font-size: 18px;
      margin: 8px 0;
      width: 80%;
      max-width: 400px;
      border: 2px solid #d2691e;
      border-radius: 5px;
      box-sizing: border-box;
      background-color: #fff8f0;
      color: #5b2400;
    }
    button {
      background-color: #c9302c;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #a91f1a;
    }
    .card {
      background-color: #fffaf5;
      border: 2px solid #ffd699;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }
    .card-header {
      font-weight: bold;
      font-size: 18px;
      color: #a52a2a;
      margin-bottom: 10px;
      border-bottom: 1px dashed #d9b38c;
      padding-bottom: 5px;
    }
    .person-block {
      margin-bottom: 10px;
      padding: 10px;
      border-left: 4px solid #ffcc80;
      background-color: #fff4e6;
    }
    .person-block span {
      display: block;
      line-height: 1.6;
      font-size: 16px;
    }
    .match-count {
      margin-bottom: 10px;
      font-weight: bold;
      color: #c9302c;
    }
    .not-found {
      margin-top: 20px;
      color: #a00;
      text-align: center;
      font-size: 18px;
    }
    .loading {
      text-align: center;
      color: #a0522d;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>2025 å¤ªå²å…‰æ˜ç¯ æŸ¥è¯¢ç³»ç»Ÿ</h1>
  <div class="centered-input">
    <input type="text" id="searchInput" placeholder="è¯·è¾“å…¥æ‰‹æœºå·ç çš„å7ä½ï¼Œæˆ–å®Œæ•´å·ç è¿›è¡ŒæŸ¥è¯¢ã€‚">
    <button onclick="search()">ğŸ” æŸ¥è¯¢</button>
  </div>
  <div id="loading" class="loading">ğŸ“¦ æ­£åœ¨è½½å…¥æ•°æ®ï¼Œè¯·ç¨å€™...</div>
  <div id="result"></div>

 
<script>
let cachedData = [];
const registrationLookup = {
  taiSui: {}, longevity: {}, wisdom: {}, arhat: {}, light: {}
};

function getCode(map, name) {
  return map[(name || '').trim().toUpperCase()] || 'æ— ç¼–å·';
}

function normalizeName(name) {
  return (name || '').trim().toUpperCase();
}

function extractMobileNumber(phone) {
  if (!phone) return '';
  const raw = phone.toString().trim()
    .replace(/^'/, '')        // å»é™¤æ’‡å·
    .replace(/\s+/g, '')      // å»ç©ºæ ¼
    .replace(/\+\d+$/, '')    // å»é™¤å°¾éƒ¨ +æ•°å­—
    .replace(/[^\d]/g, '');   // å»é™¤éæ•°å­—å­—ç¬¦

  const match = raw.match(/(\d{10})$/);  // æå–æœ€å10ä½
  return match ? match[1] : raw;
}

async function preloadData() {
  const url = "https://script.google.com/macros/s/AKfycbxU0pwJ_v7li9f274I5m23U2AV3YBDjZ_NUJ_TplrYb9Je3aIXytr8mD2bqozlAQPGuvQ/exec?mode=all";

  try {
    const res = await fetch(url);
    cachedData = await res.json();
    document.getElementById("loading").style.display = "none";
    document.getElementById("result").innerHTML = '<div class="loading">âœ… æ•°æ®å·²ç¼“å­˜ï¼Œå¯å¼€å§‹æŸ¥è¯¢ã€‚</div>';
  } catch (err) {
    document.getElementById("loading").innerText = "âŒ æ— æ³•åŠ è½½èµ„æ–™ï¼Œè¯·ç¨åé‡è¯•ã€‚";
    console.error("é¢„è½½å¤±è´¥ï¼š", err);
  }

  try {
    const fullRes = await fetch("https://script.google.com/macros/s/AKfycbzhnu9_lxiG31C2NndfeSjO0GpGiwFKNcvpazAQ7YC7F8V8jfVJARowlyKE9x9bcbQjbg/exec");
    const fullData = await fullRes.json();

    const orderAndAssign = (list, targetMap, prefix = "") => {
      list.forEach((name, idx) => {
        if (name) targetMap[name.trim().toUpperCase()] = prefix + (idx + 1);
      });
    };

    orderAndAssign(fullData.taiSui || [], registrationLookup.taiSui);
    orderAndAssign(fullData.longevity || [], registrationLookup.longevity);
    orderAndAssign(fullData.wisdom || [], registrationLookup.wisdom);
    orderAndAssign(fullData.arhat || [], registrationLookup.arhat);

    const lightList = fullData.light || [];
    const limits = { A: 627, B: 627, C: 756, D: 756, E: 644, F: 644, G: 644, H: 644 };
    let i = 0;
    for (const group in limits) {
      for (let j = 0; j < limits[group]; j++) {
        const name = lightList[i++];
        if (name) registrationLookup.light[name.trim().toUpperCase()] = `${group}${j + 1}`;
      }
    }
  } catch (e) {
    console.error("è½½å…¥ç¼–å·æ•°æ®å¤±è´¥ï¼š", e);
  }
}

function search() {
  const keyword = document.getElementById('searchInput').value.trim();

  if (!keyword || keyword.length < 7) {
    alert("è¯·è¾“å…¥æ‰‹æœºå·ç çš„å7ä½ï¼Œæˆ–å®Œæ•´å·ç è¿›è¡ŒæŸ¥è¯¢ã€‚");
    return;
  }

  const userInput = keyword;
  const userTail7 = userInput.slice(-7);

  const matched = cachedData.filter(record => {
    const cleaned = extractMobileNumber(record.phone);
    const recordTail7 = cleaned.slice(-7);
    return cleaned === userInput || recordTail7 === userTail7;
  });

  const resultEl = document.getElementById("result");

  if (matched.length === 0) {
    resultEl.innerHTML = '<div class="not-found">âŒ æ²¡æœ‰æ‰¾åˆ°å¯¹åº”èµ„æ–™</div>';
    return;
  }

  let html = `<div class="match-count">ğŸ” å…±æ‰¾åˆ° ${matched.length} ç¬”ç¬¦åˆèµ„æ–™</div>`;

  matched.forEach(record => {
    html += `<div class="card">
      <div class="card-header">ğŸ§¾ å¡«å†™è€…ï¼š${record.mainName}ã€€ğŸ“± ç”µè¯ï¼š${record.phone}</div>`;

    record.entries.forEach(entry => {
      html += `<div class="person-block">
        <span>ğŸ™ å§“åï¼š${entry.name}</span>
        <span>ç”Ÿè‚–ï¼š${entry.zodiac}</span>`;

      if (entry.taiSui) {
        html += `<span>å¤ªå²ï¼šæ˜¯ã€€ç¼–å·ï¼š${getCode(registrationLookup.taiSui, entry.name)}ã€€çº¸é‡‘ï¼š${entry.paperGold1 || "æ— "}</span>`;
      }
      if (entry.light) {
        html += `<span>å…‰æ˜ç¯ï¼šæ˜¯ã€€ç¼–å·ï¼š${getCode(registrationLookup.light, entry.name)}ã€€çº¸é‡‘ï¼š${entry.paperGold2 || "æ— "}</span>`;
      }
      if (entry.longevity) {
        html += `<span>é•¿ç”Ÿç¦„ä½ï¼šæ˜¯ã€€ç¼–å·ï¼š${getCode(registrationLookup.longevity, entry.name)}ã€€çº¸é‡‘ï¼š${entry.paperGold3 || "æ— "}</span>`;
      }
      if (entry.wisdom) {
        html += `<span>æ–‡æ˜Œå¸å›ï¼šæ˜¯ã€€ç¼–å·ï¼š${getCode(registrationLookup.wisdom, entry.name)}ã€€çº¸é‡‘ï¼š${entry.paperGold4 || "æ— "}</span>`;
      }
      if (entry.arhat) {
        html += `<span>åå…­ç½—æ±‰ï¼šæ˜¯ã€€ç¼–å·ï¼š${getCode(registrationLookup.arhat, entry.name)}ã€€çº¸é‡‘ï¼š${entry.paperGold5 || "æ— "}</span>`;
      }
      if (entry.donation) {
        html += `<span>å®‰å¥‰åŠŸå¾·é‡‘ï¼š${entry.donation}</span>`;
      }
      html += `</div>`;
    });

    html += `</div>`;
  });

  resultEl.innerHTML = html;
}

window.onload = preloadData;
</script>
</body>
</html>
