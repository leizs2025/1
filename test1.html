<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>祖先超度報名表</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      padding: 20px;
      background: #fffbe9;
      color: #333;
    }
    h1 {
      text-align: center;
      font-size: 24px;
      margin-bottom: 10px;
    }
    .ancestor-group {
      border: 2px dashed #aaa;
      padding: 10px;
      border-radius: 10px;
      margin-bottom: 20px;
      background: #fff;
    }
    label {
      display: block;
      margin-top: 8px;
      font-weight: bold;
    }
    input, select {
      width: 100%;
      padding: 6px 10px;
      margin-top: 4px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 16px;
      box-sizing: border-box;
    }
    .flex-row {
      display: flex;
      gap: 10px;
    }
    .flex-row > div {
      flex: 1;
    }
    button {
      padding: 10px 20px;
      background: #ffd369;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      margin: 10px 5px 0 0;
      cursor: pointer;
    }
    button:hover {
      background: #fcbf49;
    }
    .total {
      margin-top: 10px;
      font-weight: bold;
      color: #c92c2c;
    }
  </style>
</head>
<body>
  <h1>祖先超度報名表</h1>
  <div id="ancestorList"></div>

  <button onclick="addAncestor()">➕ 新增一位祖先</button>
  <button onclick="previewData()">📋 預覽資料</button>

  <div class="total" id="amountDisplay">本頁合計：0 元</div>

  <script>
    let ancestorData = [];

    const ITEM_PRICES = {
      token: 5,
      boat: 30,
      lotus: 6,
      paper3: 3,
      paper6: 6,
      paper27: 27
    };

    function createAncestorForm(index) {
      const ancestor = ancestorData[index];
      const container = document.createElement('div');
      container.className = 'ancestor-group';
      container.innerHTML = `
        <label>祖先/亡靈 姓名：</label>
        <input type="text" value="${ancestor.name || ''}" oninput="ancestorData[${index}].name = this.value; updateAmount();"/>

        <label>安奉地點：</label>
        <select onchange="ancestorData[${index}].placeType = this.value; renderAncestorList();">
          <option value="">-- 請選擇地點類型 --</option>
          <option value="地藏殿牌位" ${ancestor.placeType === '地藏殿牌位' ? 'selected' : ''}>地藏殿牌位</option>
          <option value="靈骨殿福位" ${ancestor.placeType === '靈骨殿福位' ? 'selected' : ''}>靈骨殿福位</option>
          <option value="墓園" ${ancestor.placeType === '墓園' ? 'selected' : ''}>墓園</option>
          <option value="牌位" ${ancestor.placeType === '牌位' ? 'selected' : ''}>牌位</option>
        </select>

        ${ancestor.placeType ? `
        <label>${ancestor.placeType}：</label>
        <input type="text" value="${ancestor.placeName || ''}" oninput="ancestorData[${index}].placeName = this.value;"/>` : ''}

        <div class="flex-row">
          <div><label>令牌</label><input type="number" min="0" value="${ancestor.token || ''}" oninput="ancestorData[${index}].token = this.value; updateAmount();"/></div>
          <div><label>配套</label><input type="number" min="0" value="${ancestor.boat || ''}" oninput="ancestorData[${index}].boat = this.value; updateAmount();"/></div>
          <div><label>蓮花</label><input type="number" min="0" value="${ancestor.lotus || ''}" oninput="ancestorData[${index}].lotus = this.value; updateAmount();"/></div>
        </div>
        <div class="flex-row">
          <div><label>紙金3</label><input type="number" min="0" value="${ancestor.paper3 || ''}" oninput="ancestorData[${index}].paper3 = this.value; updateAmount();"/></div>
          <div><label>紙金6</label><input type="number" min="0" value="${ancestor.paper6 || ''}" oninput="ancestorData[${index}].paper6 = this.value; updateAmount();"/></div>
          <div><label>紙金27</label><input type="number" min="0" value="${ancestor.paper27 || ''}" oninput="ancestorData[${index}].paper27 = this.value; updateAmount();"/></div>
        </div>

        ${index > 0 ? `<button onclick="removeAncestor(${index})">❌ 刪除此筆</button>` : ''}
      `;
      return container;
    }

    function renderAncestorList() {
      const list = document.getElementById('ancestorList');
      list.innerHTML = '';
      ancestorData.forEach((_, index) => {
        list.appendChild(createAncestorForm(index));
      });
      updateAmount();
    }

    function addAncestor() {
      if (ancestorData.length >= 8) return alert("最多只能填寫 8 位祖先！");
      ancestorData.push({});
      renderAncestorList();
    }

    function removeAncestor(index) {
      ancestorData.splice(index, 1);
      renderAncestorList();
    }

    function updateAmount() {
      const currentPageIndex = ancestorData.length - 1;
      const amounts = ancestorData.map(data => {
        return (parseInt(data.token) || 0) * ITEM_PRICES.token +
               (parseInt(data.boat) || 0) * ITEM_PRICES.boat +
               (parseInt(data.lotus) || 0) * ITEM_PRICES.lotus +
               (parseInt(data.paper3) || 0) * ITEM_PRICES.paper3 +
               (parseInt(data.paper6) || 0) * ITEM_PRICES.paper6 +
               (parseInt(data.paper27) || 0) * ITEM_PRICES.paper27;
      });
      const currentAmount = amounts[currentPageIndex] || 0;
      const totalAmount = amounts.reduce((a, b) => a + b, 0);
      document.getElementById('amountDisplay').innerText =
        ancestorData.length <= 1
          ? `本頁合計：${currentAmount} 元`
          : `目前總金額：${totalAmount} 元`;
    }

    function previewData() {
      let preview = ancestorData.map((data, i) =>
        `第 ${i + 1} 位祖先：${data.name || '未填'}\n` +
        `地點：${data.placeType || ''} - ${data.placeName || ''}\n` +
        `金額：${calculateSingleAmount(data)} 元`
      ).join('\n\n');
      const total = ancestorData.reduce((sum, d) => sum + calculateSingleAmount(d), 0);
      alert(preview + `\n\n總金額：${total} 元`);
    }

    function calculateSingleAmount(data) {
      return (parseInt(data.token) || 0) * ITEM_PRICES.token +
             (parseInt(data.boat) || 0) * ITEM_PRICES.boat +
             (parseInt(data.lotus) || 0) * ITEM_PRICES.lotus +
             (parseInt(data.paper3) || 0) * ITEM_PRICES.paper3 +
             (parseInt(data.paper6) || 0) * ITEM_PRICES.paper6 +
             (parseInt(data.paper27) || 0) * ITEM_PRICES.paper27;
    }

    // 初始化顯示第一位
    ancestorData.push({});
    renderAncestorList();
  </script>
</body>
</html>
