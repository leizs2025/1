<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>超度法会报名系统</title>
    <style>
        /* 保持之前的样式不变 */
        .project-form { margin-top: 30px; border-top: 2px solid #eee; padding-top: 20px; }
        .project-title { color: #2c3e50; border-left: 4px solid #4CAF50; padding-left: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <!-- 基础信息表單保持不變 -->

        <!-- ===== 所有项目模板 ===== -->
        <!-- 祖先超度模板（已包含） -->
        
        <!-- 水子灵超度模板 -->
        <template id="infant-template">
            <div class="entry">
                <div class="entry-header">
                    <h3>水子灵 #<span class="entry-number">1</span></h3>
                    <button class="btn btn-danger" onclick="removeEntry(this)">×</button>
                </div>
                <div class="input-group">
                    <label>阳上姓名：</label>
                    <input type="text" class="applicant-name" required>
                </div>
                <div class="input-group">
                    <label>莲位安奉类型：</label>
                    <select class="location-type" onchange="toggleLocationDetail(this)">
                        <option value="往生莲位">往生莲位</option>
                        <option value="水子灵牌位">水子灵牌位</option>
                        <option value="其他">其他</option>
                    </select>
                </div>
                <div class="input-group location-detail" style="display:none;">
                    <label>详细说明：</label>
                    <input type="text" class="location-input">
                </div>
                <!-- 相同的供品字段 -->
            </div>
        </template>

        <!-- 冤亲债主模板 -->
        <template id="debt-template">
            <div class="entry">
                <div class="entry-header">
                    <h3>冤亲债主 #<span class="entry-number">1</span></h3>
                    <button class="btn btn-danger" onclick="removeEntry(this)">×</button>
                </div>
                <div class="input-group">
                    <label>阳上姓名：</label>
                    <input type="text" class="applicant-name" required>
                </div>
                <div class="input-group">
                    <label>供奉方式：</label>
                    <select class="location-type" onchange="toggleLocationDetail(this)">
                        <option value="解冤牌位">解冤牌位</option>
                        <option value="超度专场">超度专场</option>
                        <option value="其他">其他</option>
                    </select>
                </div>
                <div class="input-group location-detail" style="display:none;">
                    <label>详细说明：</label>
                    <input type="text" class="location-input">
                </div>
                <!-- 相同的供品字段 -->
            </div>
        </template>

        <!-- 所杀生灵模板 -->
        <template id="karma-template">
            <div class="entry">
                <div class="entry-header">
                    <h3>生灵超度 #<span class="entry-number">1</span></h3>
                    <button class="btn btn-danger" onclick="removeEntry(this)">×</button>
                </div>
                <div class="input-group">
                    <label>阳上姓名：</label>
                    <input type="text" class="applicant-name" required>
                </div>
                <div class="input-group">
                    <label>生灵类型：</label>
                    <select class="location-type" onchange="toggleLocationDetail(this)">
                        <option value="陆生动物">陆生动物</option>
                        <option value="水生动物">水生动物</option>
                        <option value="其他">其他</option>
                    </select>
                </div>
                <div class="input-group location-detail" style="display:none;">
                    <label>详细说明：</label>
                    <input type="text" class="location-input">
                </div>
                <!-- 相同的供品字段 -->
            </div>
        </template>

        <!-- 地基主模板 -->
        <template id="land-template">
            <div class="entry">
                <div class="entry-header">
                    <h3>地基主 #<span class="entry-number">1</span></h3>
                    <button class="btn btn-danger" onclick="removeEntry(this)">×</button>
                </div>
                <div class="input-group">
                    <label>祭祀地址：</label>
                    <input type="text" class="location-input" required>
                </div>
                <!-- 相同的供品字段 -->
            </div>
        </template>

        <!-- ===== 预览区 ===== -->
        <div id="preview-section" class="form-section">
            <!-- 保持之前的结算样式 -->
        </div>
    </div>

    <script>
        // 增强状态管理
        const PROJECT_CONFIG = {
            ancestor: { max: 8, title: '祖先超度', fields: ['亡灵姓名', '安奉类型'] },
            infant:   { max: 5, title: '水子灵超度', fields: ['阳上姓名', '莲位类型'] },
            debt:     { max: 5, title: '冤亲债主', fields: ['阳上姓名', '供奉方式'] },
            karma:    { max: 4, title: '所杀生灵', fields: ['阳上姓名', '生灵类型'] },
            land:     { max: 2, title: '地基主', fields: ['祭祀地址'] }
        };

        // 统一条目创建函数
        function createEntry(type, index) {
            const template = document.getElementById(`${type}-template`);
            const clone = template.content.cloneNode(true);
            clone.querySelector('.entry-number').textContent = index;
            
            // 初始化供品字段
            clone.querySelectorAll('.item').forEach(input => {
                input.addEventListener('input', () => updateCalculations());
            });

            return clone;
        }

        // 统一数据收集
        function collectProjectData(type) {
            return Array.from(document.querySelectorAll(`#${type}-entries .entry`)).map(entry => {
                const baseData = {
                    items: {}
                };

                // 收集公共字段
                if(entry.querySelector('.applicant-name')) {
                    baseData.applicant = entry.querySelector('.applicant-name').value;
                }
                if(entry.querySelector('.location-type')) {
                    baseData.locationType = entry.querySelector('.location-type').value;
                }
                if(entry.querySelector('.location-input')) {
                    baseData.locationDetail = entry.querySelector('.location-input').value;
                }

                // 收集供品数据
                entry.querySelectorAll('.item').forEach(input => {
                    const key = input.classList[1];
                    baseData.items[key] = parseInt(input.value) || 0;
                });

                return baseData;
            });
        }

        // 增强金额计算
        function updateCalculations() {
            let total = 0;
            const details = [];
            const priceMap = new Map();

            // 遍历所有项目
            Object.keys(state.data.projects).forEach(projectType => {
                state.data.projects[projectType].forEach(entry => {
                    Object.entries(entry.items).forEach(([itemKey, quantity]) => {
                        const price = PRICES[itemKey];
                        const amount = quantity * price;
                        
                        if(priceMap.has(itemKey)) {
                            priceMap.set(itemKey, priceMap.get(itemKey) + amount);
                        } else {
                            priceMap.set(itemKey, amount);
                        }
                        
                        total += amount;
                    });
                });
            });

            // 生成明细
            priceMap.forEach((amount, itemKey) => {
                details.push(`
                    <div class="price-item">
                        <span>${getItemName(itemKey)}</span>
                        <span>${amount}元</span>
                    </div>
                `);
            });

            document.getElementById('price-details').innerHTML = details.join('');
            document.getElementById('total-amount').textContent = total;
        }

        // 初始化所有项目
        function initProjects() {
            Object.keys(PROJECT_CONFIG).forEach(type => {
                state.data.projects[type] = [];
                if(!document.getElementById(`${type}-template`)) {
                    console.error(`Missing template for ${type}`);
                }
            });
        }

        // 页面加载初始化
        document.addEventListener('DOMContentLoaded', () => {
            initProjects();
            initBaseForm();
        });
    </script>
</body>
</html>
