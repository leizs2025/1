<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ¨çº¿ç¥ˆç¦æŠ¥åç³»ç»Ÿ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --bg-color: #FFF8E7;
            --primary-color: #FF4444;
        }

        body {
            background: var(--bg-color);
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
        }

        .page {
            display: block;
            opacity: 1;
            transition: opacity 0.3s;
        }
        .page.hidden {
            display: none !important;
            opacity: 0;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            box-sizing: border-box;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin: 8px 0;
            font-size: 16px;
            box-sizing: border-box;
        }

        button {
            background: var(--primary-color);
            color: white;
            padding: 12px;
            border: none;
            border-radius: 25px;
            width: 100%;
            font-size: 16px;
            margin: 8px 0;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .participant-card {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            box-sizing: border-box;
        }

        .item-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
            gap: 10px;
        }

        .item-row input[type="number"] {
            width: 80px;
            padding: 8px;
            text-align: right;
        }

        #totalAmount {
            color: var(--primary-color);
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            transition: all 0.3s ease;
        }

        .delete-btn {
            background: #ff4444 !important;
            padding: 5px 10px !important;
            font-size: 12px !important;
            width: auto !important;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <!-- ç¬¬ä¸€é¡µï¼šåŸºæœ¬ä¿¡æ¯ -->
    <div id="page1" class="page card">
        <h2>åŸºæœ¬ä¿¡æ¯</h2>
        <input type="tel" id="phone" placeholder="æ‰‹æœºå·" required>
        <input type="text" id="registrant" placeholder="å¡«å†™äººå§“å" required>
        <select id="blessType">
            <option value="æ¶ˆç¾">æ¶ˆç¾æ³•ä¼š</option>
            <option value="è¶…åº¦">è¶…åº¦æ³•ä¼š</option>
        </select>
        <button id="nextBtn">ä¸‹ä¸€æ­¥</button>
    </div>

    <!-- ç¬¬äºŒé¡µï¼šç¥ˆç¦ä¿¡æ¯ -->
    <div id="page2" class="page card hidden">
        <h2>ç¥ˆç¦ä¿¡æ¯</h2>
        <div id="participants"></div>
        <button id="addParticipantBtn" style="background:#4CAF50;">+ æ·»åŠ ç¥ˆç¦è€…</button>
        <div id="totalAmount">æ€»é‡‘é¢ï¼š0 å…ƒ</div>
        <button id="previewBtn">é¢„è§ˆæäº¤</button>
    </div>

    <!-- ç¬¬ä¸‰é¡µï¼šé¢„è§ˆé¡µ -->
    <div id="previewPage" class="page card hidden">
        <h2>ä¿¡æ¯é¢„è§ˆ</h2>
        <div id="previewContent"></div>
        <button id="backBtn" style="background:#666;">è¿”å›ä¿®æ”¹</button>
        <button id="downloadBtn">ä¸‹è½½PDF</button>
        <button id="submitBtn">ç¡®è®¤æäº¤</button>
    </div>

<script>
// ç³»ç»Ÿæ•°æ®å­˜å‚¨
let formData = {
    phone: '',
    registrant: '',
    type: 'æ¶ˆç¾',
    participants: [{
        name: '',
        address: '',
        items: { 
            token: 0,
            homa: 0,
            paper3: 0,
            paper6: 0
        }
    }]
};

// åˆå§‹åŒ–åº”ç”¨
function initializeApp() {
    bindEventListeners();
    renderParticipants();
}

// äº‹ä»¶ç»‘å®š
function bindEventListeners() {
    document.getElementById('nextBtn').addEventListener('click', nextPage);
    document.getElementById('addParticipantBtn').addEventListener('click', addParticipant);
    document.getElementById('previewBtn').addEventListener('click', showPreview);
    document.getElementById('backBtn').addEventListener('click', goBack);
    document.getElementById('downloadBtn').addEventListener('click', downloadPDF);
    document.getElementById('submitBtn').addEventListener('click', submitData);
}

// é¡µé¢åˆ‡æ¢
function nextPage() {
    const phone = document.getElementById('phone').value.trim();
    const registrant = document.getElementById('registrant').value.trim();
    
    if (!phone || !registrant) {
        alert('è¯·å¡«å†™æ‰‹æœºå·å’Œå¡«å†™äººå§“å');
        return;
    }

    formData.phone = phone;
    formData.registrant = registrant;
    formData.type = document.getElementById('blessType').value;

    document.getElementById('page1').classList.add('hidden');
    document.getElementById('page2').classList.remove('hidden');
}

// æ·»åŠ å‚ä¸è€…
function addParticipant() {
    if (formData.participants.length >= 13) {
        alert('æœ€å¤šæ·»åŠ 13ä½ç¥ˆç¦è€…');
        return;
    }
    formData.participants.push({
        name: '',
        address: '',
        items: { 
            token: 0,
            homa: 0,
            paper3: 0,
            paper6: 0
        }
    });
    renderParticipants();
}

// åˆ é™¤å‚ä¸è€…
function removeParticipant(index) {
    index = parseInt(index);
    if (index > 0 && index < formData.participants.length) {
        formData.participants.splice(index, 1);
        renderParticipants();
    }
}

// æ¸²æŸ“å‚ä¸è€…
function renderParticipants() {
    const container = document.getElementById('participants');
    container.innerHTML = formData.participants.map((p, index) => `
        <div class="participant-card">
            <h3>ç¥ˆç¦è€… ${index+1} 
                ${index > 0 ? `<button class="delete-btn" data-index="${index}">åˆ é™¤</button>` : ''}
            </h3>
            <input placeholder="å§“åï¼ˆå¯é€‰ï¼‰" 
                value="${p.name}" 
                data-index="${index}" 
                data-field="name">
            <input placeholder="åœ°å€ï¼ˆå¯é€‰ï¼‰" 
                value="${p.address}" 
                data-index="${index}" 
                data-field="address">
            
            <div class="item-row">
                <span>ç¥ˆç¦ä»¤ç‰Œï¼ˆ5å…ƒï¼‰</span>
                <input type="number" min="0" value="${p.items.token}"
                    data-index="${index}" 
                    data-field="token">
            </div>
            <div class="item-row">
                <span>å°æŠ¤æ‘©ç‰‡ï¼ˆ1å…ƒï¼‰</span>
                <input type="number" min="0" value="${p.items.homa}"
                    data-index="${index}" 
                    data-field="homa">
            </div>
            <div class="item-row">
                <span>çº¸é‡‘ï¼ˆ3å…ƒï¼‰</span>
                <input type="number" min="0" value="${p.items.paper3}"
                    data-index="${index}" 
                    data-field="paper3">
            </div>
            <div class="item-row">
                <span>çº¸é‡‘ï¼ˆ6å…ƒï¼‰</span>
                <input type="number" min="0" value="${p.items.paper6}"
                    data-index="${index}" 
                    data-field="paper6">
            </div>
        </div>
    `).join('');

    // ç»‘å®šåŠ¨æ€å…ƒç´ äº‹ä»¶
    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', () => removeParticipant(btn.dataset.index));
    });
    
    document.querySelectorAll('[data-field]').forEach(input => {
        input.addEventListener('input', handleInputChange);
    });
    
    updateTotal();
}

// å¤„ç†è¾“å…¥å˜æ›´
function handleInputChange(e) {
    const index = parseInt(e.target.dataset.index);
    const field = e.target.dataset.field;
    const value = e.target.value;

    if (['token', 'homa', 'paper3', 'paper6'].includes(field)) {
        const numValue = Math.max(0, parseInt(value) || 0);
        formData.participants[index].items[field] = numValue;
    } else {
        formData.participants[index][field] = value;
    }
    updateTotal();
}

// æ›´æ–°æ€»é‡‘é¢
function updateTotal() {
    const total = formData.participants.reduce((sum, p) => 
        sum + p.items.token*5 + p.items.homa*1 + p.items.paper3*3 + p.items.paper6*6, 0);
    document.getElementById('totalAmount').textContent = `æ€»é‡‘é¢ï¼š${total} å…ƒ`;
}

// é¢„è§ˆåŠŸèƒ½
function showPreview() {
    document.getElementById('page2').classList.add('hidden');
    document.getElementById('previewPage').classList.remove('hidden');
    
    document.getElementById('previewContent').innerHTML = `
        <div class="preview-section">
            <h3>åŸºæœ¬ä¿¡æ¯</h3>
            <p>ğŸ“± æ‰‹æœºå·ï¼š${formData.phone}</p>
            <p>ğŸ“ å¡«å†™äººï¼š${formData.registrant}</p>
            <p>ğŸ® æ³•ä¼šç±»åˆ«ï¼š${formData.type}</p>
        </div>
        
        ${formData.participants.map((p, i) => `
            <div class="preview-item">
                <h4>ğŸ™ ç¥ˆç¦è€… #${i+1}ï¼š${p.name || 'åŒ¿åç¥ˆç¦è€…'}</h4>
                ${p.address ? `<p>ğŸ“ åœ°å€ï¼š${p.address}</p>` : ''}
                <div class="preview-items">
                    <p>ğŸ›’ ç‰©å“æ¸…å•ï¼š</p>
                    <ul>
                        <li>ğŸ« ç¥ˆç¦ä»¤ç‰Œï¼š${p.items.token} ä¸ª</li>
                        <li>ğŸ”¥ å°æŠ¤æ‘©ç‰‡ï¼š${p.items.homa} ç‰‡</li>
                        <li>ğŸ’° 3å…ƒçº¸é‡‘ï¼š${p.items.paper3} ä»½</li>
                        <li>ğŸ’° 6å…ƒçº¸é‡‘ï¼š${p.items.paper6} ä»½</li>
                    </ul>
                </div>
            </div>
        `).join('')}
        
        <div class="total-preview">
            <h3>ğŸ’° æ€»é‡‘é¢ï¼š${document.getElementById('totalAmount').textContent}</h3>
        </div>
    `;
}

// PDFç”Ÿæˆ
async function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    try {
        // åŠ è½½ä¸­æ–‡å­—ä½“
        const fontUrl = 'https://cdn.jsdelivr.net/npm/@jspdf-community/fontregistry-free@1.0.0/fonts/SourceHanSansCN-Normal.ttf';
        const fontData = await fetch(fontUrl).then(r => r.arrayBuffer());
        
        // æ³¨å†Œå­—ä½“
        doc.addFileToVFS('SourceHanSansCN.ttf', arrayBufferToBase64(fontData));
        doc.addFont('SourceHanSansCN.ttf', 'SourceHanSansCN', 'normal');
        doc.setFont('SourceHanSansCN');

        // è®¾ç½®åŸºç¡€æ ·å¼
        doc.setFontSize(18);
        doc.text(`ç¥ˆç¦æŠ¥åè¡¨ï¼ˆ${new Date().toLocaleDateString()}ï¼‰`, 20, 20);

        // åŸºæœ¬ä¿¡æ¯
        let y = 40;
        doc.setFontSize(12);
        doc.text(`â–ª æ‰‹æœºå·ï¼š${formData.phone}`, 20, y);
        doc.text(`â–ª å¡«å†™äººï¼š${formData.registrant}`, 20, y + 10);
        doc.text(`â–ª æ³•ä¼šç±»åˆ«ï¼š${formData.type}`, 20, y + 20);
        y += 40;

        // ç¥ˆç¦è€…ä¿¡æ¯
        formData.participants.forEach((p, index) => {
            doc.setFontSize(14);
            doc.text(`ç¥ˆç¦è€… ${index + 1}ï¼š${p.name || 'åŒ¿å'}`, 20, y);
            doc.setFontSize(12);
            
            if (p.address) {
                doc.text(`åœ°å€ï¼š${p.address}`, 30, y + 10);
                y += 10;
            }

            const items = [
                ["ç¥ˆç¦ä»¤ç‰Œ", p.items.token, 5],
                ["å°æŠ¤æ‘©ç‰‡", p.items.homa, 1],
                ["3å…ƒçº¸é‡‘", p.items.paper3, 3],
                ["6å…ƒçº¸é‡‘", p.items.paper6, 6]
            ];

            items.forEach(([name, qty, price], i) => {
                const yPos = y + 20 + (i * 10);
                doc.text(`${name}ï¼š${qty} Ã— ${price}å…ƒ = ${qty * price}å…ƒ`, 30, yPos);
            });

            y += 60 + (items.length * 10);
        });

        // æ€»é‡‘é¢
        doc.setFontSize(16);
        doc.text(`èµåŠ©æ€»é‡‘é¢ï¼š${document.getElementById('totalAmount').textContent}`, 20, y + 20);
        
        doc.save('ç¥ˆç¦æŠ¥åè¡¨.pdf');
    } catch (error) {
        console.error('PDFç”Ÿæˆå¤±è´¥:', error);
        alert('PDFç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
    }
}

// ArrayBufferè½¬Base64å·¥å…·å‡½æ•°
function arrayBufferToBase64(buffer) {
    let binary = '';
    const bytes = new Uint8Array(buffer);
    for (let i = 0; i < bytes.byteLength; i++) {
        binary += String.fromCharCode(bytes[i]);
    }
    return window.btoa(binary);
}
// è¿”å›ä¿®æ”¹
function goBack() {
    document.getElementById('previewPage').classList.add('hidden');
    document.getElementById('page2').classList.remove('hidden');
}

// æäº¤æ•°æ®
async function submitData() {
    try {
        const response = await fetch('YOUR_GOOGLE_APPS_SCRIPT_URL', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(formData)
        });
        alert(response.ok ? 'æäº¤æˆåŠŸï¼' : 'æäº¤å¤±è´¥');
        if(response.ok) window.location.reload();
    } catch (error) {
        console.error('æäº¤é”™è¯¯:', error);
        alert('ç½‘ç»œè¿æ¥é”™è¯¯');
    }
}

// å¯åŠ¨åº”ç”¨
document.addEventListener('DOMContentLoaded', initializeApp);
</script>
</body>
</html>
